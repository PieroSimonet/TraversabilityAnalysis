<?xml version="1.0"?>
<launch>

  <arg name="manager"             default="realsense2_camera_manager"/>

  <include ns="camera" file="$(find trav_analysis_2)/launch/custom_rs_rgbd.launch"> 
    <arg name="enable_pointcloud"   default="true"/>
    <arg name="clip_distance"       default="3"/>
    <arg name="manager"             value="$(arg manager)"/>
    <arg name="ordered_pc" value="true" />
  </include> 

  <group ns="camera">
    <group ns="camera">
  
      <!-- todo move this to nodelet -->
      <node pkg="ema_pc" type="ema_pc" name="ema_pc" output="screen">
        <remap from="pc_input" to="/camera/camera/depth/color/points" />
        <remap from="pc_output" to="/ema_pc/points" />
        <param name="ema_coeff" value="0.9" />
        <param name="hz" value="30" />
      </node> 
    
      <!-- Run a VoxelGrid filter to clean NaNs and downsample the data -->
      <node pkg="nodelet" type="nodelet" name="voxel_grid" args="load pcl/VoxelGrid $(arg manager)" output="screen">
        <remap from="~input" to="/ema_pc/points" />
        <rosparam>
          filter_field_name: z
          filter_limit_min: 0.5
          filter_limit_max: 3
          filter_limit_negative: False
          leaf_size: 0.025
        </rosparam>
      </node> 

      <node name="plane_fitter" type="check_planarity" pkg="plane_fitter" output="screen">
        <remap from="/sense3d/scan" to="/camera/camera/voxel_grid/output"/>
        <param name="_min_percentage" value="2" />
      </node>

      
      <!-- <node pkg="road_pcl" type="road_pcl" name="road_pcl">
        <param name="topicName" value="/voxel_grid/output" />
        <param name="maxIter" value="1000" />
        <param name="leafSize" value="0.05" />
        <param name="distanceThresh" value="0.05" />
        <remap from="/roadpcl" to="/roadpcl" />
      </node>  -->
    
      <node pkg="nodelet" type="nodelet" name="traversability" args="load trav_analysis_2/Trav $(arg manager) false">
        <remap from="/visual/pointcloud" to="/camera/camera/plane_fitter/inliers" />
        <param name="load_path" value="$(find trav_analysis_2)/models/results00" />
      </node>

    </group>
  </group>

  <!--  old to remove -->
  <!--<node pkg="trav_analysis_2" type="ros_receiver" name="traversability" output="screen">
      <remap from="/visual/pointcloud" to="/ema_pc/points" />
      <param name="load_path" value="$(find trav_analysis_2)/models/results00" />
  </node> -->

</launch>
